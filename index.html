<!DOCTYPE html>
<html>
<!-- command to deploy app:- firebase deploy -->

<head>
    <title>Daily Task</title>
    <link rel="icon" type="image/png" href="./dt.png" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/5.0.0-alpha1/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-r4NyP46KrjDleawBgD5tp8Y7UzmLA05oM1iAEQ17CSuDqnUK2+k9luXQOfXJCJ4I" crossorigin="anonymous">

    <style>
        body {
            background-color: #F6F4F2;
        }

        .group {
            min-height: 100vh;
        }

        .urlList:hover {
            background-color: white;
            font-style: italic;
        }

        a:hover {
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="container-fluid">
        <div class="row mt-3">
            <div class="col-3 bg-dark rounded group text-center">
                <h3 class="text-white">Hi, Nishant</h3>
                <h6 class="text-white" id="gwei"></h6>
                <input type="text" id="groupInput" class="form-control my-2" placeholder="Add Group">
                <!-- <ul id="sidebar" class="list-group"> -->
                <hr class="text-white">
                <ul id="sidebar" class="list-unstyled">

                </ul>
            </div>
            <div class="col-9 rounded">
                <input type="text" id="urlInput" class="form-control my-2"
                    placeholder="Paste Url and then press Enter key">
                <hr>
                <ul id="urlList" class="list-unstyled">

                </ul>
            </div>
        </div>
    </div>
    <script type="module">
        // Import the functions you need from the SDKs you need
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, child, get, push, set, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        const firebaseConfig = {
            apiKey: "AIzaSyAJSpQPp0ls-xK8YShFEX75VRHWkzYCCZg",
            authDomain: "dailytask-2dd88.firebaseapp.com",
            databaseURL: "https://dailytask-2dd88-default-rtdb.firebaseio.com",
            projectId: "dailytask-2dd88",
            storageBucket: "dailytask-2dd88.appspot.com",
            messagingSenderId: "262250599266",
            appId: "1:262250599266:web:fae89e66228ad3418dd23b",
            measurementId: "G-2254PBYC96"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        // Reference to the tasks collection
        let selectedGroup = localStorage.getItem("group") || null;
        let listOfKeys = [];
        let listOfUrls = [];


        //sidebar
        let groupInput = document.getElementById("groupInput");
        groupInput.addEventListener("keyup", async function (event) {
            if (groupInput.value == null || groupInput.value.trim() == "") {
                return
            }
            if (event.keyCode === 13) {
                event.preventDefault();
                await set(ref(db, `groups/${groupInput.value.toUpperCase()}`), groupInput.value.toUpperCase())
                groupInput.value = "";
                loadGroup();
            }
        });
        async function loadGroup() {
            const querySnapshot = await get(ref(db, "groups"));
            let sidebar = document.getElementById("sidebar");
            sidebar.innerHTML = "";
            querySnapshot.forEach((item) => {
                let li = document.createElement("li");
                li.className = "d-flex justify-content-between align-items-center mb-2 text-white rounded"
                let button = document.createElement("button");
                button.className = "btn btn-danger"
                button.innerHTML = '<i class="material-icons">delete</i>'
                if (selectedGroup == item.val()) {
                    li.className = "d-flex justify-content-between align-items-center bg-secondary mb-2 font-weight-bold text-white rounded";
                }
                button.addEventListener('click', async () => {
                    let confirmation = prompt("Please write groupname to delete")
                    if (confirmation.toUpperCase() == item.val()) {
                        await remove(ref(db, `groups/${item.key}`))
                        await remove(ref(db, `tasks/${item.val()}`))
                        localStorage.removeItem("group")
                        loadUrl();
                    } else {
                        alert("Groupname did not match")
                    }
                })
                li.textContent = item.val();
                li.appendChild(button);
                sidebar.appendChild(li);

                li.addEventListener('click', () => {
                    selectedGroup = item.val();
                    localStorage.setItem("group", item.val());
                    loadGroup()
                    loadUrl();
                })
            });
        }

        loadGroup();
        loadUrl();
        getGas();

        //input urls
        let urlInput = document.getElementById("urlInput");
        urlInput.addEventListener("keyup", async function (event) {
            if (urlInput.value == null || urlInput.value.trim() == "" || selectedGroup == "") {
                return
            }
            if (event.keyCode === 13) {
                event.preventDefault();
                await push(ref(db, `tasks/${selectedGroup}`), {
                    "url": urlInput.value,
                    "completed": false
                })
                urlInput.value = "";
                loadUrl();
            }
        });
        async function loadUrl() {
            listOfKeys = []
            listOfUrls = []
            const querySnapshot = await get(ref(db, `tasks/${selectedGroup}`));
            urlList.innerHTML = "";

            if (querySnapshot.exists()) {
                let ulrList = document.getElementById("urlList");
                let li = document.createElement("li");
                li.className = "d-flex justify-content-center align-items-center";
                let button = document.createElement("button");
                button.className = "btn btn-sm btn-success mb-1";
                button.innerText = 'Open All Urls';
                button.addEventListener('click', async () => {
                    openAllUrls();
                })
                li.appendChild(button);
                urlList.appendChild(li);
            }
            querySnapshot.forEach((item) => {
                listOfKeys.push(item.key);
                listOfUrls.push(item.val());
                let li = document.createElement("li");
                li.className = "d-flex justify-content-between align-items-center border urlList"
                let leftDiv = document.createElement("div");
                let rightDiv = document.createElement("div");
                rightDiv.className = "d-flex"
                let checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'form-check-input mx-2'
                checkbox.addEventListener('change', async () => {
                    await set(ref(db, `tasks/${selectedGroup}/${item.key}`), { ...item.val(), "completed": !item.val().completed })
                    loadUrl();
                })
                let a = document.createElement("a");
                a.textContent = item.val().url;
                a.addEventListener('click', () => {
                    window.open(replaceVariable(item.val().url), '_blank');
                })
                a.classList.add("text-decoration-none")
                if (item.val().completed) {
                    a.classList.add("text-decoration-line-through")
                    checkbox.checked = true;
                    li.className = "d-flex justify-content-between align-items-center border bg-dark"
                }
                let deleteButton = document.createElement("button");
                deleteButton.className = "btn btn-sm btn-danger"
                deleteButton.innerHTML = '<i class="material-icons">delete</i>'
                deleteButton.addEventListener('click', async () => {
                    await remove(ref(db, `tasks/${selectedGroup}/${item.key}`))
                    loadUrl();
                })
                let moveUpButton = document.createElement("button");
                moveUpButton.className = "btn btn-sm btn-info"
                moveUpButton.innerHTML = '<i class="material-icons">arrow_upward</i>'
                moveUpButton.addEventListener('click', async () => {
                    for (let i = 0; i < listOfKeys.length; i++) {
                        if (item.key == listOfKeys[i]) {
                            if (i == 0) {
                                return;
                            }
                            await set(ref(db, `tasks/${selectedGroup}/${listOfKeys[i - 1]}`), listOfUrls[i]);
                            await set(ref(db, `tasks/${selectedGroup}/${listOfKeys[i]}`), listOfUrls[i - 1]);
                            loadUrl();
                        }
                    }
                })
                let moveDownButton = document.createElement("button");
                moveDownButton.className = "btn btn-sm btn-warning"
                moveDownButton.innerHTML = '<i class="material-icons">arrow_downward</i>'
                moveDownButton.addEventListener('click', async () => {
                    for (let i = 0; i < listOfKeys.length; i++) {
                        if (item.key == listOfKeys[i]) {
                            if (i == listOfKeys.length - 1) {
                                return;
                            }
                            await set(ref(db, `tasks/${selectedGroup}/${listOfKeys[i + 1]}`), listOfUrls[i]);
                            await set(ref(db, `tasks/${selectedGroup}/${listOfKeys[i]}`), listOfUrls[i + 1]);
                            loadUrl();
                        }
                    }
                })
                leftDiv.appendChild(checkbox);
                leftDiv.appendChild(a);
                rightDiv.appendChild(moveUpButton);
                rightDiv.appendChild(moveDownButton);
                rightDiv.appendChild(deleteButton);
                li.appendChild(leftDiv);
                li.appendChild(rightDiv);
                urlList.appendChild(li);
            });
        }

        function replaceVariable(url) {//example "https://github.com/${key}/Gitcoin/edit/main/jan.py"
            if (url.indexOf("${") >= 0) {
                let key = url.substring(url.indexOf("${") + 2, url.indexOf("}"));
                let value = localStorage.getItem(key);

                let regex = new RegExp("\\$\\{" + key + "\\}", "g");
                url = url.replace(regex, value);
            }
            return url;
        }

        function openAllUrls() {
            for (let i = 0; i < listOfUrls.length; i++) {
                window.open(replaceVariable(listOfUrls[i].url), '_blank');
            }
        }

        function getGas() {
            fetch('https://api.etherscan.io/api?module=gastracker&action=gasoracle&apikey=2M1WXTYFPYCYJ4HMB4BJ61EIUI8JTZ8C9H')
                .then(response => response.json())
                .then(data => {
                    document.title = data.result.ProposeGasPrice + " Gwei"
                    document.getElementById("gwei").innerText = "Average Gwei = " + data.result.ProposeGasPrice;
                })
                .catch(error => console.error('Error:', error));
        }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
</body>

</html>
